<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Task Timer (Slim)</title>
  <style>
    :root{
      /* === 1. Color tokens === */
      --main:#63CA9F;     /* メイン（鮮やか） */
      --sub:#CFE0C9;      /* サブ（パステル） */
      --neutral:#C4C4C4;  /* ニュートラル/無効（グレー） */
      --bgSoft:#FFFFFF;   /* 背景（白） */
      --ink:#111111;
      --muted:#6b7280;
      --darkGray:#4A4A4A;

      --line:#e5e7eb;
      --shadow: 0 1px 0 rgba(17,17,17,.04), 0 8px 24px rgba(17,17,17,.06);
      --radius: 14px;

      /* derived */
      --btnTextLight:#ffffff;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue",
                   Arial, "Noto Sans", sans-serif;
      color:var(--ink);
      background:var(--bgSoft);
    }

    .wrap{ width:100%; max-width: 980px; margin:0 auto; padding:10px; }

    /* Timer outline (mint) */
    .card{
      border:2px solid var(--main);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      background:#fff;
      overflow:hidden;
    }

    .head{
      display:flex; align-items:center; justify-content:space-between;
      padding:10px 12px;
      border-bottom:1px solid var(--line);
      background:#fff;
    }
    .title{ display:flex; gap:10px; align-items:center; min-width:0; }
    .badge{
      width:32px; height:32px;
      border:1px solid var(--line);
      border-radius:10px;
      display:grid; place-items:center;
      background:linear-gradient(180deg, #fff, #fafafa);
    }
    .title h1{
      font-size:13px; margin:0; font-weight:650; letter-spacing:.02em;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }

    .hint{ font-size:12px; color:var(--muted); display:flex; gap:10px; align-items:center; flex-wrap:wrap; }

    .dot{
      width:10px; height:10px; border-radius:50%;
      border:1px solid var(--line); display:inline-block; position:relative; top:1px;
      background:#fff;
    }
    .dot.run{ background: var(--main); border-color: var(--main); }
    .dot.pause{ background: var(--sub); border-color: var(--sub); }
    .dot.stop{ background:#fff; border-color: var(--neutral); }

    /* === 2. Status text rules === */
    #stateText{
      font-weight: 700; /* Bold always */
      color: var(--neutral); /* default: stopped */
    }
    .state-running #stateText{ color: var(--main); }
    .state-stopped #stateText{ color: var(--neutral); }
    .state-paused  #stateText{ color: var(--neutral); } /* spec: only Running/Stopped; keep neutral */

    .grid{
      padding:10px 12px;
      display:grid;
      gap:10px;
      grid-template-columns: minmax(360px, 1.15fr) minmax(280px, .85fr);
      align-items:start;
    }
    @media (max-width: 640px){
      .grid{ grid-template-columns:1fr; }
    }

    .panel{
      border:1px solid var(--line);
      border-radius: 14px;
      background:#fff;
      padding: 12px;
    }

    label{ font-size:11px; color:var(--muted); }
    .row{ display:grid; gap:6px; }

    input[type="text"]{
      width:100%;
      border:1px solid var(--line);
      border-radius: 12px;
      padding: 9px 11px;
      font-size: 13px;
      outline:none;
      background:#fff;
    }
    input[type="text"]:focus{
      border-color: rgba(99,202,159,.9);
      box-shadow: 0 0 0 3px rgba(99,202,159,.18);
    }

    .time{
      font-variant-numeric: tabular-nums;
      font-size: 36px;
      letter-spacing:.04em;
      line-height:1.05;
      margin: 6px 0 8px;
    }

    .btns{ display:flex; gap:10px; flex-wrap:wrap; }

    /* Base button */
    button{
      border:1px solid var(--line);
      background:#fff;
      border-radius: 12px;
      padding: 9px 11px;
      font-size: 12.5px;
      cursor:pointer;
      transition: transform .02s ease, box-shadow .2s ease, border-color .2s ease, background-color .2s ease, color .2s ease;
      display:inline-flex;
      align-items:center;
      gap:8px;
      user-select:none;
    }
    button:active{ transform: translateY(1px); }
    button:hover{ box-shadow: 0 6px 18px rgba(17,17,17,.06); }

    /* Keep disabled legible but subdued */
    button[disabled]{
      opacity:.55;
      cursor:not-allowed;
      box-shadow:none;
    }

    /* === 3. Main button styling rules (dynamic via container class) === */
    /* Start/Stop: default to neutral outline */
    .btn-start, .btn-stop{
      background: transparent;
      border-color: var(--neutral);
      color: var(--neutral);
    }

    /* When stopped => Start is primary fill */
    .state-stopped .btn-start{
      background: var(--main);
      border-color: var(--main);
      color: var(--btnTextLight);
      opacity: 1;
    }
    /* When running => Stop is primary fill */
    .state-running .btn-stop{
      background: var(--main);
      border-color: var(--main);
      color: var(--btnTextLight);
      opacity: 1;
    }

    /* Pause (always sub) */
    .btn-pause{
      background: var(--sub);
      border-color: var(--sub);
      color: var(--darkGray);
    }

    /* Reset (always bgSoft + neutral outline/text) */
    .btn-reset{
      background: var(--bgSoft);
      border-color: var(--neutral);
      color: var(--neutral);
      border-style:dashed; /* ✅ match Report */
    }

    /* Total */
    .miniTotal{
      display:flex; justify-content:space-between; align-items:baseline; gap:10px;
      padding: 10px 12px;
      border:1px solid var(--line);
      border-radius: 12px;
      background:#fff;
    }
    .miniTotal b{
      font-variant-numeric: tabular-nums;
      font-size: 14px;
    }

    .logWrap{ display:none; margin-top:10px; }
    .logWrap.open{ display:block; }

    .logBox{
      border:1px solid var(--line);
      border-radius:12px;
      padding:10px;
      background:#fff;
      max-height: 220px;
      overflow:auto;
    }

    /* === 4. Log buttons === */
    .btn-log{
      background: var(--sub);
      border-color: var(--sub);
      color: var(--darkGray);
    }
    .btn-clear{
      background: var(--bgSoft);
      border-color: var(--neutral);
      color: var(--neutral);
      border-style:dashed; /* ✅ match Report */
    }

    svg{ display:block }
    .stroke{ stroke:#111; stroke-width:1.6; fill:none; stroke-linecap:round; stroke-linejoin:round; }
    .accentFill{ fill: var(--main); opacity:.35; }
  </style>
</head>

<body>
  <div class="wrap">
    <!-- state class is applied here: state-stopped / state-running / state-paused -->
    <div class="card state-stopped" id="appCard" role="application" aria-label="Task Timer Slim">
      <div class="head">
        <div class="title">
          <div class="badge" aria-hidden="true">
            <svg width="20" height="20" viewBox="0 0 24 24">
              <path class="stroke" d="M12 8v5l3 2"/>
              <path class="stroke" d="M19.5 12a7.5 7.5 0 1 1-15 0a7.5 7.5 0 0 1 15 0Z"/>
              <path class="stroke" d="M9 3h6"/>
              <path class="stroke" d="M12 3v2"/>
              <circle class="accentFill" cx="18.5" cy="6.5" r="2.2"></circle>
            </svg>
          </div>
          <div style="min-width:0">
            <h1>Task Timer (Slim)</h1>
          </div>
        </div>

        <div class="hint" title="Status">
          <span class="dot stop" id="stateDot"></span>
          <span id="stateText">Stopped</span>
        </div>
      </div>

      <div class="grid">
        <div class="panel">
          <div class="row">
            <label for="taskName">Task name (optional)</label>
            <input id="taskName" type="text" placeholder="e.g., Doc prep / Research" />
          </div>

          <div class="time" id="timeDisplay">00:00:00</div>

          <div class="btns">
            <button class="btn-start" id="startBtn" type="button">
              <span aria-hidden="true">▶</span> Start
            </button>
            <button class="btn-pause" id="pauseBtn" type="button" disabled>
              <span aria-hidden="true">Ⅱ</span> Pause
            </button>
            <button class="btn-stop" id="stopBtn" type="button" disabled>
              <span aria-hidden="true">■</span> Stop
            </button>
            <button class="btn-reset" id="resetBtn" type="button">
              <span aria-hidden="true">↺</span> Reset
            </button>
          </div>

          <div class="hint" style="margin-top:8px;">
            <span>Stop adds the time to the log.<br>Reset clears the timer without adding it to the log.</span>
          </div>
        </div>

        <div class="panel">
          <div style="display:flex; justify-content:space-between; align-items:baseline; gap:10px;">
            <label style="margin:0;"></label>
            <div style="font-size:11px; color:var(--muted);" id="todayLabel"></div>
          </div>

          <div class="miniTotal" style="margin-top:8px;">
            <span style="font-size:12px; color:var(--muted);">Total</span>
            <b id="todayTotal">00:00:00</b>
          </div>
          <div style="margin-top:6px; font-size:11px; color:var(--muted);">
            Total time of the logs below
          </div>

          <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:10px;">
            <button class="btn-log" id="toggleLogBtn" type="button">
              <span aria-hidden="true">▾</span> Open log
            </button>
            <button class="btn-log" id="copySummaryBtn" type="button">
              <span aria-hidden="true">⧉</span> Copy log
            </button>
            <button class="btn-clear" id="clearTodayBtn" type="button">
              <span aria-hidden="true">✕</span> Clear
            </button>
          </div>

          <div class="logWrap" id="logWrap">
            <div class="logBox" id="logArea" style="margin-top:10px;">
              <div style="color:var(--muted); font-size:12px;">No entries yet.</div>
            </div>
            <div style="display:flex; justify-content:flex-start; align-items:center; margin-top:8px;">
              <span style="font-size:11px; color:var(--muted);">
                Log time is the start time
              </span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
(() => {
  const pad = (n) => String(n).padStart(2, "0");

  const fmtHMS = (ms) => {
    const total = Math.max(0, Math.floor(ms / 1000));
    const h = Math.floor(total / 3600);
    const m = Math.floor((total % 3600) / 60);
    const s = total % 60;
    return `${pad(h)}:${pad(m)}:${pad(s)}`;
  };

  const fmtYMDHM = (ts) => {
    const d = new Date(ts);
    const y = d.getFullYear();
    const mo = pad(d.getMonth() + 1);
    const da = pad(d.getDate());
    const hh = pad(d.getHours());
    const mm = pad(d.getMinutes());
    return `${y}-${mo}-${da} ${hh}:${mm}`;
  };

  const appCard = document.getElementById("appCard");

  const taskName = document.getElementById("taskName");
  const timeDisplay = document.getElementById("timeDisplay");
  const startBtn = document.getElementById("startBtn");
  const pauseBtn = document.getElementById("pauseBtn");
  const stopBtn = document.getElementById("stopBtn");
  const resetBtn = document.getElementById("resetBtn");
  const stateDot = document.getElementById("stateDot");
  const stateText = document.getElementById("stateText");

  const todayLabel = document.getElementById("todayLabel");
  const todayTotalEl = document.getElementById("todayTotal");
  const toggleLogBtn = document.getElementById("toggleLogBtn");
  const logWrap = document.getElementById("logWrap");
  const logArea = document.getElementById("logArea");
  const copySummaryBtn = document.getElementById("copySummaryBtn");
  const clearTodayBtn = document.getElementById("clearTodayBtn");

  let timer = null, running = false, paused = false, startAt = 0, elapsed = 0;
  let startedStamp = 0;

  const STORAGE_KEY = "shiz-task-timer-logs-v1";
  const NAME_KEY = "shiz-task-timer-lastname-v1";
  const ALL_KEY = "__all__";

  const loadRaw = () => { try { return JSON.parse(localStorage.getItem(STORAGE_KEY) || "{}"); } catch { return {}; } };
  const saveRaw = (obj) => localStorage.setItem(STORAGE_KEY, JSON.stringify(obj));

  const getAllArray = () => {
    const raw = loadRaw();

    // already migrated
    if (Array.isArray(raw[ALL_KEY])) return raw[ALL_KEY];

    // migrate legacy { "YYYY-MM-DD": [...] } into { "__all__": [...] }
    const keys = Object.keys(raw);
    const merged = [];
    for (const k of keys) {
      const arr = raw[k];
      if (Array.isArray(arr)) {
        for (const e of arr) merged.push(e);
      }
    }
    const migrated = { [ALL_KEY]: merged };
    saveRaw(migrated);
    return migrated[ALL_KEY];
  };

  const setAllArray = (arr) => {
    saveRaw({ [ALL_KEY]: arr });
  };

  const loadLastName = () => localStorage.getItem(NAME_KEY) || "";
  const saveLastName = (v) => localStorage.setItem(NAME_KEY, v);

  const setCardStateClass = (mode) => {
    appCard.classList.remove("state-running","state-stopped","state-paused");
    if (mode === "run") appCard.classList.add("state-running");
    else if (mode === "pause") appCard.classList.add("state-paused");
    else appCard.classList.add("state-stopped");
  };

  const setUIState = (mode) => {
    stateDot.className = "dot " + mode;

    if (mode === "run") {
      stateText.textContent = "Running";
    } else if (mode === "pause") {
      stateText.textContent = "Paused";
    } else {
      stateText.textContent = "Stopped";
    }

    // enable/disable logic (same as before)
    startBtn.disabled = (mode === "run");
    pauseBtn.disabled = (mode === "stop");
    stopBtn.disabled  = (mode === "stop");
    pauseBtn.textContent = (mode === "pause") ? "▶ Resume" : "Ⅱ Pause";

    // apply dynamic styling target
    setCardStateClass(mode);
  };

  const tick = () => timeDisplay.textContent = fmtHMS(elapsed + (performance.now() - startAt));

  const start = () => {
    if (running) return;

    // first start stamp for this measurement (keep across pause/resume)
    if (!paused && elapsed === 0) startedStamp = Date.now();

    running = true; paused = false;
    startAt = performance.now();
    timer = setInterval(tick, 250);
    setUIState("run");
  };

  const pauseOrResume = () => {
    if (!running && !paused) return;
    if (running) {
      running = false; paused = true;
      clearInterval(timer); timer = null;
      elapsed += (performance.now() - startAt);
      setUIState("pause");
    } else {
      paused = false; running = true;
      startAt = performance.now();
      timer = setInterval(tick, 250);
      setUIState("run");
    }
  };

  const reset = () => {
    clearInterval(timer); timer = null;
    running = false; paused = false;
    startAt = 0; elapsed = 0;
    startedStamp = 0;
    timeDisplay.textContent = "00:00:00";

    // Reset clears task input
    taskName.value = "";
    saveLastName("");

    setUIState("stop");
  };

  const msSum = (arr) => arr.reduce((a,b)=>a+(b.ms||0),0);

  const renderToday = () => {
    // Today row removed: keep empty
    todayLabel.textContent = "";

    const arr = getAllArray();
    todayTotalEl.textContent = fmtHMS(msSum(arr));

    if (!arr.length) {
      logArea.innerHTML = `<div style="color:var(--muted); font-size:12px;">No entries yet.</div>`;
      return;
    }

    const rows = arr.slice().reverse().map(e => {
      const ts = (e.start || e.t || Date.now());
      const when = fmtYMDHM(ts);

      const nameEsc = (e.name||"Task").replace(/[&<>"']/g, s => ({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
      }[s]));

      return `
        <div style="display:grid; grid-template-columns:132px 1fr auto; gap:8px; align-items:center; padding:6px 0; border-top:1px dashed var(--line);">
          <div style="color:var(--muted); font-size:12px; font-variant-numeric: tabular-nums;">${when}</div>
          <div style="font-size:13px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">${nameEsc}</div>
          <div style="font-variant-numeric: tabular-nums; font-size:13px;">${fmtHMS(e.ms)}</div>
        </div>`;
    }).join("");

    logArea.innerHTML = rows;
  };

  const stopAndLog = () => {
    if (running) {
      elapsed += (performance.now() - startAt);
      clearInterval(timer); timer = null;
      running = false;
    }
    if (!paused && elapsed === 0) { setUIState("stop"); return; }
    paused = false;

    const arr = getAllArray();

    const name = (taskName.value || "").trim() || "Task";
    arr.push({ start: startedStamp || Date.now(), t: Date.now(), name, ms: elapsed });
    setAllArray(arr);

    // Stop clears timer + task input
    reset();
    renderToday();
  };

  const copyLog = async () => {
    const arr = getAllArray();
    const total = fmtHMS(msSum(arr));

    // Format: DateTime | Duration | Task
    const lines = arr.map(e => {
      const when = fmtYMDHM(e.start || e.t || Date.now());
      const dur  = fmtHMS(e.ms);
      const name = (e.name || "Task");
      return `${when} | ${dur} | ${name}`;
    });

    const text = [`Total: ${total}`, ...lines].join("\n");

    try {
      await navigator.clipboard.writeText(text);
      copySummaryBtn.textContent = "✓ Copied";
      setTimeout(()=>copySummaryBtn.innerHTML = '<span aria-hidden="true">⧉</span> Copy log', 900);
    } catch {
      const ta=document.createElement("textarea");
      ta.value=text; document.body.appendChild(ta); ta.select();
      document.execCommand("copy"); document.body.removeChild(ta);
      copySummaryBtn.textContent = "✓ Copied";
      setTimeout(()=>copySummaryBtn.innerHTML = '<span aria-hidden="true">⧉</span> Copy log', 900);
    }
  };

  const clearToday = () => {
    // no confirm, clear immediately
    setAllArray([]);
    renderToday();
  };

  const toggleLog = () => {
    const open = logWrap.classList.toggle("open");
    toggleLogBtn.innerHTML = open
      ? '<span aria-hidden="true">▴</span> Close log'
      : '<span aria-hidden="true">▾</span> Open log';
  };

  startBtn.addEventListener("click", start);
  pauseBtn.addEventListener("click", pauseOrResume);
  stopBtn.addEventListener("click", stopAndLog);
  resetBtn.addEventListener("click", reset);

  toggleLogBtn.addEventListener("click", toggleLog);
  copySummaryBtn.addEventListener("click", copyLog);
  clearTodayBtn.addEventListener("click", clearToday);

  taskName.value = loadLastName();
  taskName.addEventListener("input", () => saveLastName(taskName.value));

  setUIState("stop");
  renderToday();
})();
</script>
</body>
</html>



