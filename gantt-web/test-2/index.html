<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>施工工程表（Webガント）</title>
  <style>
    :root{
      --grid: #e5e7eb;
      --gridPrint: #d7dbe3;
      --ink: #111827;
      --muted: #6b7280;
      --bar: #4f8bd6;          /* バー色（必要なら変更） */
      --bg: #ffffff;
      --monthLine: #111111;    /* 月境界（太線） */
      --tickLine: #111111;     /* 10日区切り（線） */
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans JP", Arial, sans-serif;
      color: var(--ink);
      background: var(--bg);
    }

    /* ====== screen ====== */
    .top{
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding:12px 16px;
      border-bottom:1px solid var(--grid);
      gap:12px;
      flex-wrap:wrap;
    }
    .title{ font-weight:700; }
    .controls{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
      justify-content:flex-end;
    }
    .controls button{
      padding:8px 12px;
      border:1px solid var(--grid);
      background:#fff;
      border-radius:8px;
      cursor:pointer;
    }
    .controls input[type="file"]{
      border:1px solid var(--grid);
      padding:6px;
      border-radius:8px;
      background:#fff;
      max-width:320px;
    }
    .hint{ color:var(--muted); font-size:12px; }
    .meta{
      padding:10px 16px;
      color:var(--muted);
      font-size:12px;
      line-height:1.6;
    }

    .gantt-wrap{
      padding: 8px 16px 24px;
      overflow:auto;
    }
    .gantt{
      display:grid;
      border:1px solid var(--grid);
      background:#fff;
    }

    /* 基本：縦線は出さない（10日区切りだけ後で付与） */
    .cell{
      border-bottom:1px solid var(--grid);
      border-right:none;
      padding:4px 6px;
      font-size:12px;
      white-space:nowrap;
      background:#fff;
    }
    .cell.center{ text-align:center; }

    /* 左2列（screen固定） */
    .cell.phase, .cell.task{
      position:sticky;
      left:0;
      background:#fff;
      z-index:3;
      border-right:2px solid var(--monthLine); /* 左列と日付領域の区切り（太線） */
    }
    .cell.task{
      left:160px;
      z-index:3;
      border-right:2px solid var(--monthLine);
    }

    /* 日付ヘッダ */
    .day{
      text-align:center;
      padding:4px 0;
      font-size:11px;
    }

    /* 10日区切り縦線（太め） */
    .vline{
      border-right:2px solid var(--tickLine);
    }

    /* 月初縦線（さらに太い） */
    .monthStart{
      border-left:3px solid var(--monthLine);
    }

    /* バーセル */
    .barCell{
      position:relative;
      height: var(--rowH, 22px);
      padding:0;
    }
    .barCell .fill{
      position:absolute;
      inset:0;
    }
    .barCell.on .fill{
      background: var(--bar);
    }

    /* ラベル（開始列に m/d-m/d のみ） */
    .barCell .label{
      position:absolute;
      top:-16px;
      left:2px;
      font-size:11px;
      color: var(--ink);
      background: rgba(255,255,255,0.95);
      padding:0 3px;
      border:0;
      pointer-events:none;
      white-space:nowrap;
    }

    /* 改ページ */
    .pageBreak{ }

    /* ====== print ====== */
    @media print{
      /* 画面操作UIは印刷しない（必要なら印刷用ヘッダを別途用意できます） */
      .top, .meta{ display:none !important; }
      body{ background:#fff; }
      .gantt-wrap{ overflow:visible; padding:0; }

      @page{
        size: A3 landscape;   /* ★A3横 */
        margin: 8mm;
      }

      .cell{
        font-size:10px;
        border-bottom:1px solid var(--gridPrint);
      }

      /* sticky解除 */
      .cell.phase, .cell.task{ position:static !important; }

      /* 内容列は折り返し */
      .cell.task{
        white-space:normal;
        line-height:1.1;
      }

      .day{ font-size:9px; }

      .vline{ border-right:2px solid var(--tickLine) !important; }
      .monthStart{ border-left:3px solid var(--monthLine) !important; }

      .barCell .label{ font-size:9px; top:-14px; }

      /* 5ヶ月→6ヶ月目 月初で改ページ */
      .pageBreak{
        break-before: page;
        page-break-before: always;
      }
    }
  </style>
</head>

<body>
  <header class="top">
    <div class="title">施工工程表（Webガント）</div>

    <div class="controls">
      <button id="btnPrint" type="button" onclick="window.print()">印刷（A3横）</button>
      <label class="hint" for="file">CSVアップロード：</label>
      <input id="file" type="file" accept=".csv,text/csv" />
      <span class="hint">（ドラッグ＆ドロップ可 / 端末内に保存）</span>
      <button id="btnClear" type="button">読み込みデータをクリア</button>
    </div>
  </header>

  <main>
    <section class="meta" id="meta"></section>
    <section class="gantt-wrap">
      <div id="gantt"></div>
    </section>
  </main>

  <script>
    /**
     * CSV仕様（ヘッダー必須）:
     * phase,task,start,end
     * 土・基礎工事,配筋,2026-03-06,2026-03-12
     *
     * 表示仕様（添付イメージ寄せ）:
     * - 縦線は 10/20/月末 のみ（＋月初は太線）
     * - 日曜・祝日は表記しない（背景も出さない）
     * - バーは実働日のみ（日曜・祝日は塗らない）
     * - ラベルは開始セルに m/d-m/d のみ
     * - 印刷はA3横、横幅は自動で収め、行高もA3縦に合わせて自動調整
     * - 5ヶ月=1ページ、6ヶ月目月初で改ページ
     */
    const CSV_PATH = "./data/schedule.csv";
    const STORAGE_KEY = "gantt_schedule_csv";

    // 祝日（必要に応じて追加／別ファイル読み込みにも拡張可）
    const HOLIDAYS_YYYYMMDD = new Set([
      "2026-01-01","2026-01-12","2026-02-11","2026-02-23","2026-03-20",
      "2026-04-29","2026-05-03","2026-05-04","2026-05-05",
      "2026-07-20","2026-08-11","2026-09-21","2026-09-22","2026-09-23",
      "2026-10-12","2026-11-03","2026-11-23"
    ]);

    function mmToPx(mm){ return (mm / 25.4) * 96; } // 96dpi換算

    function ymd(d){
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,"0");
      const day = String(d.getDate()).padStart(2,"0");
      return `${y}-${m}-${day}`;
    }
    function isSunday(d){ return d.getDay() === 0; }
    function isHoliday(d){ return HOLIDAYS_YYYYMMDD.has(ymd(d)); }
    function isNonWorkingDay(d){ return isSunday(d) || isHoliday(d); }

    function parseCSV(text){
      const lines = text.trim().split(/\r?\n/);
      const header = lines.shift().split(",").map(s => s.trim());
      return lines.filter(l => l.trim()).map(line => {
        const cols = line.split(",").map(s => s.trim());
        const obj = {};
        header.forEach((h, i) => obj[h] = cols[i] ?? "");
        return obj;
      });
    }
    function toDate(s){
      const [y,m,d] = s.split("-").map(Number);
      return new Date(y, m-1, d);
    }
    function fmtMD(d){ return `${d.getMonth()+1}/${d.getDate()}`; }
    function addDays(d, n){ const x = new Date(d); x.setDate(x.getDate()+n); return x; }
    function sameDay(a,b){ return a.getFullYear()===b.getFullYear() && a.getMonth()===b.getMonth() && a.getDate()===b.getDate(); }
    function monthKey(d){ return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}`; }

    function buildRange(items){
      let min = null, max = null;
      for(const it of items){
        const s = toDate(it.start);
        const e = toDate(it.end);
        if(!min || s < min) min = s;
        if(!max || e > max) max = e;
      }
      const start = new Date(min.getFullYear(), min.getMonth(), 1);
      const end = new Date(max.getFullYear(), max.getMonth()+1, 0);
      return {start, end};
    }
    function dateList(start, end){
      const days = [];
      for(let d=new Date(start); d<=end; d=addDays(d,1)) days.push(new Date(d));
      return days;
    }
    function groupByPhase(items){
      const map = new Map();
      for(const it of items){
        const k = it.phase;
        if(!map.has(k)) map.set(k, []);
        map.get(k).push(it);
      }
      return map;
    }

    // 5ヶ月=1ページ → 6ヶ月目の月初で改ページ
    function calcSplitMonth(start){
      return new Date(start.getFullYear(), start.getMonth()+5, 1);
    }

    async function loadInitialCSV(){
      const saved = localStorage.getItem(STORAGE_KEY);
      if(saved && saved.trim()) return saved;
      const res = await fetch(CSV_PATH, { cache: "no-store" });
      if(!res.ok) throw new Error("初期CSVが見つかりません。CSVをアップロードしてください。");
      return await res.text();
    }

    function setupUploader(onCSVLoaded){
      const input = document.getElementById("file");
      const btnClear = document.getElementById("btnClear");

      input?.addEventListener("change", async (e) => {
        const file = e.target.files?.[0];
        if(!file) return;
        const text = await file.text();
        localStorage.setItem(STORAGE_KEY, text);
        onCSVLoaded(text);
      });

      btnClear?.addEventListener("click", () => {
        localStorage.removeItem(STORAGE_KEY);
        location.reload();
      });

      window.addEventListener("dragover", (e) => e.preventDefault());
      window.addEventListener("drop", async (e) => {
        e.preventDefault();
        const file = e.dataTransfer.files?.[0];
        if(!file) return;
        if(!file.name.toLowerCase().endsWith(".csv")) return;
        const text = await file.text();
        localStorage.setItem(STORAGE_KEY, text);
        onCSVLoaded(text);
      });
    }

    function addCell(root, text, className, span=1){
      const div = document.createElement("div");
      div.className = className || "cell";
      div.textContent = text ?? "";
      if(span > 1) div.style.gridColumn = `span ${span}`;
      root.appendChild(div);
      return div;
    }

    function isPrintMode(){
      return window.matchMedia && window.matchMedia("print").matches;
    }

    function computeLayout(daysCount, rowCount){
      const print = isPrintMode();

      if(!print){
        // 画面用（固定）
        return {
          phaseW: "160px",
          taskW: "320px",
          dayW:  "18px",
          rowH:  "22px"
        };
      }

      // A3横: 420×297mm, margin 8mm
      const pageWmm = 420, pageHmm = 297, marginMm = 8;
      const printWpx = mmToPx(pageWmm - marginMm*2);
      const printHpx = mmToPx(pageHmm - marginMm*2);

      // 左2列（印刷用は狭め）
      const phaseWpx = 110;
      const taskWpx  = 160;

      // 日付列幅：必ず横幅に収める（下限〜上限）
      let dayWpx = Math.floor((printWpx - phaseWpx - taskWpx) / daysCount);
      dayWpx = Math.max(6, Math.min(dayWpx, 18));

      // 行高：A3縦に合わせて“広げる”
      // ヘッダ2行 + 本体rowCount。余白分を控えめに見積もり。
      const headerRows = 2;
      const totalRows = headerRows + rowCount;
      let rowHpx = Math.floor((printHpx - 60) / totalRows); // 60pxはバッファ
      rowHpx = Math.max(18, Math.min(rowHpx, 28));

      return {
        phaseW: phaseWpx + "px",
        taskW:  taskWpx  + "px",
        dayW:   dayWpx   + "px",
        rowH:   rowHpx   + "px"
      };
    }

    function renderFromCSV(text){
      const ganttRoot = document.getElementById("gantt");
      ganttRoot.innerHTML = "";
      ganttRoot.className = "gantt";

      const raw = parseCSV(text);
      const items = raw
        .filter(x => x.phase && x.task && x.start && x.end)
        .map(x => ({ phase:x.phase, task:x.task, start:x.start, end:x.end }));

      if(items.length === 0){
        document.getElementById("meta").textContent =
          "CSVの内容が空、または列名が違います。ヘッダーは phase,task,start,end を想定しています。";
        return;
      }

      const {start, end} = buildRange(items);
      const days = dateList(start, end);
      const splitMonth = calcSplitMonth(start);

      // 6ヶ月目の月初が何列目か（0-based）
      let pageBreakColIndex = null;
      for(let di=0; di<days.length; di++){
        if(days[di].getDate() === 1 && sameDay(days[di], splitMonth)){
          pageBreakColIndex = di;
          break;
        }
      }

      // 画面用meta（印刷では非表示）
      document.getElementById("meta").textContent =
        `期間：${start.getFullYear()}/${start.getMonth()+1}/${start.getDate()}〜`+
        `${end.getFullYear()}/${end.getMonth()+1}/${end.getDate()}（${days.length}日）`;

      // ===== 印刷時：横幅フィット + 行高調整 =====
      const layout = computeLayout(days.length, items.length);
      ganttRoot.style.setProperty("--rowH", layout.rowH);
      ganttRoot.style.gridTemplateColumns = [layout.phaseW, layout.taskW, ...days.map(_ => layout.dayW)].join(" ");

      // === ヘッダ1段目：月（例: 3月） ===
      addCell(ganttRoot, "施工工程", "cell center");
      addCell(ganttRoot, "内容", "cell center");

      const monthSpans = [];
      let i=0;
      while(i<days.length){
        const mk = monthKey(days[i]);
        let j=i;
        while(j<days.length && monthKey(days[j])===mk) j++;
        monthSpans.push({ from:i, to:j-1 });
        i=j;
      }

      for(const sp of monthSpans){
        const d0 = days[sp.from];
        const label = `${d0.getMonth()+1}月`;
        addCell(ganttRoot, label, "cell center", sp.to - sp.from + 1);
      }

      // === ヘッダ2段目：10/20/月末のみ数字表示（縦線もここだけ） ===
      addCell(ganttRoot, "", "cell");
      addCell(ganttRoot, "", "cell");

      for(let di=0; di<days.length; di++){
        const d = days[di];
        const next = addDays(d,1);
        const isLast = next.getMonth() !== d.getMonth();
        const isTick = (d.getDate()===10 || d.getDate()===20 || isLast);

        const show = isTick ? String(d.getDate()) : "";

        const classes = ["cell","day"];
        if(d.getDate()===1) classes.push("monthStart");
        if(isTick) classes.push("vline");
        if(pageBreakColIndex !== null && di === pageBreakColIndex) classes.push("pageBreak");

        addCell(ganttRoot, show, classes.join(" "));
      }

      // === 本体：日曜・祝日は表記も色も出さない（ただ塗らない） ===
      const byPhase = groupByPhase(items);

      for(const [phase, list] of byPhase){
        for(const it of list){
          addCell(ganttRoot, phase, "cell phase");
          addCell(ganttRoot, it.task, "cell task");

          const s = toDate(it.start);
          const e = toDate(it.end);

          for(let di=0; di<days.length; di++){
            const d = days[di];

            const inRange = (d >= s && d <= e);
            const nonWork = isNonWorkingDay(d);

            // 実働バー：範囲内＆休日でない
            const isWorkBar = inRange && !nonWork;

            const next = addDays(d,1);
            const isLast = next.getMonth() !== d.getMonth();
            const isTick = (d.getDate()===10 || d.getDate()===20 || isLast);

            const cell = document.createElement("div");
            cell.className =
              "cell barCell"
              + (isWorkBar ? " on" : "")
              + (d.getDate()===1 ? " monthStart" : "")
              + (isTick ? " vline" : "")
              + (pageBreakColIndex !== null && di === pageBreakColIndex ? " pageBreak" : "");

            const fill = document.createElement("div");
            fill.className = "fill";
            cell.appendChild(fill);

            // ラベル：開始日にのみ m/d-m/d
            if(sameDay(d, s)){
              const label = document.createElement("div");
              label.className = "label";
              label.textContent = `${fmtMD(s)}-${fmtMD(e)}`;
              cell.appendChild(label);
            }

            ganttRoot.appendChild(cell);
          }
        }
      }
    }

    async function main(){
      setupUploader((newText) => renderFromCSV(newText));

      try{
        const text = await loadInitialCSV();
        renderFromCSV(text);
      }catch(err){
        console.warn(err);
        document.getElementById("meta").textContent =
          "初期CSVが見つかりません。CSVをアップロード（またはドラッグ＆ドロップ）してください。";
      }

      // 印刷前後に印刷レイアウトへ再描画（A方式の安定化）
      window.addEventListener("beforeprint", async () => {
        const saved = localStorage.getItem(STORAGE_KEY);
        const txt = saved && saved.trim() ? saved : await loadInitialCSV().catch(()=> "");
        if(txt) renderFromCSV(txt);
      });

      window.addEventListener("afterprint", async () => {
        const saved = localStorage.getItem(STORAGE_KEY);
        const txt = saved && saved.trim() ? saved : await loadInitialCSV().catch(()=> "");
        if(txt) renderFromCSV(txt);
      });
    }

    main().catch(err => {
      console.error(err);
      document.getElementById("meta").textContent = "表示に失敗しました。CSVの形式を確認してください。";
      document.getElementById("gantt").textContent = "エラーが発生しました。";
    });
  </script>
</body>
</html>

